# Last Mile Transport - EV Smart Hub Booking System
## Comprehensive Project Documentation

**Project Name:** Last Mile Transport  
**Version:** 1.0.0  
**Current Focus:** EV Smart Hub Booking System  
**Build Target:** Android (Firebase + Google Maps)  
**Date:** February 21, 2026

---

## Table of Contents
1. [Project Overview](#project-overview)
2. [Architecture & Tech Stack](#architecture--tech-stack)
3. [Feature Set](#feature-set)
4. [User Flow](#user-flow)
5. [File Structure](#file-structure)
6. [Database Schema](#database-schema)
7. [API Integration](#api-integration)
8. [Key Pages & Components](#key-pages--components)
9. [Navigation Flow](#navigation-flow)
10. [Configuration & Setup](#configuration--setup)
11. [Future Enhancements](#future-enhancements)
12. [Common Issues & Solutions](#common-issues--solutions)

---

## Project Overview

**Last Mile Transport** is a Flutter mobile application designed to provide **last-mile electric vehicle (EV) transportation**. The app enables users to:
- Browse and book electric bicycles from distributed hubs
- Track pricing in real-time based on distance
- View optimized routes via maps
- Make secure payments
- Generate booking QR codes for bicycle unlocking

### Core Business Logic
1. **Hub-Based Model:** EV bicycles are stationed at multiple hubs across localities
2. **Dynamic Pricing:** ₹5 per km + ₹1 per extra minute of rental
3. **Real-Time Route Planning:** Uses OpenRouteService API for optimal directions
4. **Booking Lifecycle:** Search → Map View → Payment → QR Code → Ride

---

## Architecture & Tech Stack

### Frontend
- **Framework:** Flutter (Dart)
- **State Management:** setState (Stateful Widgets)
- **UI Components:** Material Design 3

### Backend
- **Authentication:** Firebase Authentication (Phone Number)
- **Database (NoSQL):** Firestore (document store) + Realtime Database (JSON)
- **Cloud:** Firebase Project (com.example.lastmile_transport)

### Maps & Location
- **Google Maps Flutter:** Real-time map rendering
- **Geolocator:** User location tracking
- **OpenRouteService (ORS) API:** Route calculation & distance/time estimation

### External Services
- **ORS API Key:** Embedded in code (requires valid API quota)
- **Firebase Config:** Configured via `firebase_options.dart` and `google-services.json`

### Dependencies (Key)
```yaml
flutter:
  sdk: flutter
google_maps_flutter: ^2.x
geolocator: ^11.x
cloud_firestore: ^4.x
firebase_database: ^10.x
firebase_auth: ^4.x
http: ^1.x
qr_flutter: ^4.x
sliding_up_panel: ^2.x
```

---

## Feature Set

### ✅ **Implemented Features**

#### 1. Authentication
- Phone-based login via Firebase Auth
- Auto-redirect to home on successful auth

#### 2. EV Smart Hub Booking (Core Feature)
- **Search Page:** Tabbed UI with two tabs — "Hub to Hub" and "Rental". Hub-to-Hub provides multi-dropdown selection for source/destination hubs; Rental tab supports scheduled rental bookings (partial implementation)
- **Auto Distance Calculation:** ORS API computes actual distance between hubs
- **Dynamic Pricing:** Price = (distance × ₹5) + (extra minutes × ₹1)
- **Time Estimation:** 10 minutes per km (auto-calculated)
- **Bicycle Availability Check:** Queries Realtime DB for available bikes at source hub

#### 3. Map Visualization
- **Two Booking Modes:**
  - **Exploration Mode:** Shows 4 nearest localities + 10 nearest hubs with optimal route (blue)
  - **Booking Mode:** Displays source/dest hubs with dual routes (blue: user→source, purple: source→dest)
- **Real-time User Location:** Blue marker (Azure hue)
- **Hub Markers:** Green (source), Red (destination)
- **Route Animation:** Camera auto-fits all booking routes

#### 4. Payment Flow
- **Payment Methods:** Google Pay, PhonePe, Paytm, Credit/Debit Card, UPI
- **Order Summary:** Displays total amount, from/to, distance, duration
- **Bicycle Allocation:** Locks an available bike at source hub to user
- **Booking Creation:** Stores booking with status "booked" under Realtime DB subpaths `bookings/hub_to_hub` or `bookings/rental` depending on booking type

#### 5. QR Code Generation
- **Encode:** Booking payload (bookingId, bicycleId, userPhone, etc.)
- **Display:** Full-screen QR code for physical bike unlock

#### 6. Booking Details Stored
- bookingId (unique, generated by Realtime DB)
- userPhone (from Firebase Auth)
- sourceHub / destinationHub
- bicycleId (allocated bike)
- bookingStatus ("booked")
- allocatedMinutes (estimated + extra)
- createdAt (server timestamp)

---

## User Flow

### Step-by-Step Booking Journey

```
┌─────────────────┐
│  Login Screen   │
│  (Phone Auth)   │
└────────┬────────┘
         │
         ▼
┌─────────────────────────┐
│  Home (EVMapScreen)     │
│  Shows nearby hubs (4)  │
│  Auto-route to 10 hubs  │
│  [Search Button]        │
└────────┬────────────────┘
         │ [Tap Search]
         ▼
┌──────────────────────────────┐
│  Search Page                 │
│  1. Choose Source Locality   │
│  2. Choose Source Hub        │
│  3. Choose Dest Locality     │ ← Auto-triggers distance calc
│  4. Choose Dest Hub          │ ← ORS API computes distance, time, price
│  [Show calculated details]   │
│  [Optional: Extra minutes]   │
└────────┬─────────────────────┘
         │ [Proceed to Map]
         ▼
┌──────────────────────────────────┐
│  Booking Map (EVMapScreen)       │
│  - User location (Azure marker)  │
│  - Source hub (Green marker)     │
│  - Dest hub (Red marker)         │
│  - Dual routes (Blue + Purple)   │
│  - Bottom panel:                 │
│    From/To, Distance, Time, Price│
│  [Proceed to Payment button]     │
└────────┬─────────────────────────┘
         │ [Tap Proceed to Payment]
         ▼
┌──────────────────────────────────┐
│  Payment Page                    │
│  - Order Summary                 │
│  - Select Payment Method         │
│  [Pay button]                    │
└────────┬─────────────────────────┘
         │ [Tap Pay]
         │ (Backend: Allocate bike + Create booking)
         ▼
┌──────────────────────────────────┐
│  QR Code Screen                  │
│  - Full-screen QR code           │
│  (Encodes booking payload)       │
│  [Back: Go to Home]              │
└──────────────────────────────────┘
```

### Key Validation Checks
1. **Selection Complete:** All 4 dropdowns must be filled
2. **Distance Calculated:** Must wait for ORS response (distanceKm > 0)
3. **Bicycle Available:** At least one "availability: yes" in source hub
4. **Payment Method:** Must select a payment method before paying
5. **Navigation Cleanup:** After booking, payment & search pages are cleared from navigation stack

---

## File Structure

### Core App Files
```
lib/
├── main.dart                           # App entry, Firebase init, Auth routing
├── home.dart                           # EVMapScreen (main map + exploration mode)
├── login.dart                          # PhoneLoginScreen (Firebase auth)
├── otpscreen.dart                      # OtpScreen (phone verification)
│
├── EV_smartHub_screens/
│   ├── search_page.dart               # Browse & select hubs, calc distance/price
│   ├── booking_map.dart               # (Deprecated/Commented out - use EVMapScreen booking mode)
│   ├── payment_page.dart              # Payment selection & booking creation
│   ├── qr_code_screen.dart            # QR display for bike unlock
│   ├── ride_started_screen.dart       # Ride status (future use)
│
├── widgets/
│   └── app_drawer.dart                # Drawer menu (navigation)
│
├── theme/
│   └── app_theme.dart                 # App theme configuration
│
├── utlis/                              # (Note: typo in folder name)
│   ├── fare_calculator.dart           # Pricing logic
│   └── meter_price.dart               # Distance-based pricing
│
├── firebase_options.dart              # Firebase config (auto-generated)
│
├── Paid_Lift/                         # (Legacy / Future feature)
└── Grouping_feature/                  # (Legacy / Future feature)
```

---

## Database Schema

### Firestore Collections

#### `EV-Hubs` (Main Hub Directory)
```
EV-Hubs/
├── {localityName}/                   # Document: locality ID
│   ├── region:
│   │   ├── center: { lat: num, long: num }
│   │   └── radius_m: number           # Radius in meters
│   └── Hubs/                          # Sub-collection
│       └── {hubName}/                 # Document: hub ID
│           ├── Up: { lat: num, long: num }  # Direction coordinate
│           └── Down: { lat: num, long: num } # Direction coordinate

Example:
EV-Hubs/Pune/Hubs/Pashan/
  Up: { lat: 18.567, long: 73.812 }
  Down: { lat: 18.568, long: 73.813 }
```

#### `users` (User Profiles)
```
users/
└── {uid}/                            # Document: Firebase user ID
    ├── location: { lat: num, long: num }
    └── timestamp: Timestamp          # Last update
```

### Realtime Database (JSON)

#### `bicycles` (Bike Inventory)
```
bicycles/
├── {sourceLocality}/
│   └── {sourceHub}/
│       └── {bikeId}/
│           ├── availability: "yes" | "no"
│           └── allocated_to: "userPhone" (when booked)

Example:
bicycles/Pune/Pashan/bike_001/
  availability: "yes"
  allocated_to: null
```

#### `bookings` (Booking History — Realtime DB)
```
bookings/
├── hub_to_hub/
│   └── {autoGeneratedId}/
│       ├── bookingId: string
│       ├── bookingType: "hub_to_hub"
│       ├── userPhone: string
│       ├── sourceLocality: string
│       ├── sourceHub: string
│       ├── destLocality: string
│       ├── destinationHub: string
│       ├── bicycleId: string
│       ├── distanceKm: number
│       ├── allocatedMinutes: number
│       ├── price: number
│       ├── bookingStatus: "booked"
│       └── createdAt: timestamp
└── rental/
    └── {autoGeneratedId}/
        ├── bookingId: string
        ├── bookingType: "rental"
        ├── userPhone: string
        ├── sourceLocality: string
        ├── sourceHub: string
        ├── submissionLocality: string
        ├── submissionHub: string
        ├── sameHub: bool
        ├── bicycleId: string
        ├── scheduledDate: string
        ├── startTime: string
        ├── endTime: string
        ├── durationMinutes: number
        ├── distanceKm: number
        ├── price: number
        ├── bookingStatus: "booked"
        ├── penaltyCharge: number
        └── createdAt: timestamp
```

Example (hub_to_hub):
```
bookings/hub_to_hub/-NF7kP9...abc/
  bookingId: "-NF7kP9...abc"
  bookingType: "hub_to_hub"
  userPhone: "+919876543210"
  sourceLocality: "Pune"
  sourceHub: "Pashan"
  destLocality: "Pune"
  destinationHub: "Koregaon"
  bicycleId: "bike_001"
  distanceKm: 4.52
  allocatedMinutes: 45
  price: 27.60
  bookingStatus: "booked"
  createdAt: 1708516800000
```

---

## API Integration

### OpenRouteService (ORS) API

**Endpoint:** `https://api.openrouteservice.org/v2/directions/driving-car/geojson`

**Authentication:** API Key in header
```
Authorization: {orsApiKey}
Content-Type: application/json
```

**Request Body:**
```json
{
  "coordinates": [
    [lon1, lat1],  // Start (source hub)
    [lon2, lat2]   // End (destination hub)
  ]
}
```

**Response Structure:**
```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "LineString",
        "coordinates": [[lon, lat], [lon, lat], ...]
      },
      "properties": {
        "summary": {
          "distance": 5420.5,  // meters
          "duration": 325.2    // seconds
        }
      }
    }
  ]
}
```

**Usage in Code:**
- `search_page.dart`: Distance calculation between hubs
- `home.dart`: Route visualization with optimal waypoints

**Current ORS Key:** Hardcoded (should move to environment variables for production)

---

## Key Pages & Components

### 1. **EVMapScreen** (`home.dart`)
**Purpose:** Main map interface with dual functionality

**State Variables:**
- `currentPosition`: User's GPS location
- `userMarkers`, `hubMarkers`, `localityCircles`, `polylines`: Map elements
- `nearestHubs`: Top 10 hubs by distance

**Two Modes:**
- **Exploration Mode** (no bookingData):
  - Shows 4 nearest localities as circles (green)
  - Displays 10 nearest hubs as markers (green)
  - Draws optimal route connecting user → all hubs (blue)
  
- **Booking Mode** (bookingData provided):
  - Shows user location (Azure marker)
  - Shows source hub (Green marker) + destination hub (Red marker)
  - Draws two routes: user→source (Blue), source→destination (Purple)
  - Bottom panel shows booking summary with payment button

**Bottom Panel Content:**
- Exploration: Clickable hub list for routing
- Booking: Summary cards (from/to/distance/time/price) + payment button

---

### 2. **EVSmartHubSearchPage** (`search_page.dart`)
**Purpose:** Hub selection with real-time distance & pricing

**Key Methods:**
- `_loadLocalties()`: Fetch all localities from Firestore
- `_loadHubs()`: Fetch hubs for selected locality
- `_getHubCoordinates()`: Extract lat/lon from hub document (handles "Up"/"Down" keys)
- `_calculateDistanceAndPrice()`: Call ORS API, parse response, update UI
- `_checkBicycleAvailability()`: Query Realtime DB for available bikes at source hub
- `_proceed()`: Navigate to booking map with all calculated data

**ORS Response Parsing:**
Handles multiple ORS response shapes:
- Standard: `data["routes"][0]["summary"]["distance"]`
- GeoJSON: `data["features"][0]["properties"]["summary"]["distance"]`
- Segments: Sum of `data["features"][0]["properties"]["segments"][*]["distance"]`

**Navigation:** `pushReplacement()` → removes search page from stack

---

### 3. **PaymentPage** (`EV_smartHub_screens/payment_page.dart`)
**Purpose:** Payment method selection & booking creation

**Payment Methods:**
- Google Pay
- PhonePe
- Paytm
- Credit/Debit Card
- UPI ID

**Booking Logic (`_processPayment()`):**
1. Find available bicycle at source hub (availability = "yes")
2. Lock bike: Set `availability: "no"` + `allocated_to: userPhone`
3. Create booking record in Realtime DB with all details
4. **Calculate allocated time:** `estimatedMinutes + extraMinutes`
5. Navigate to QR screen with `pushAndRemoveUntil()` → clears payment & search pages

---

### 4. **QRCodeScreen** (`EV_smartHub_screens/qr_code_screen.dart`)
**Purpose:** Display QR code for physical bike unlock

**QR Payload:**
```json
{
  "bookingId": "-NF7kP9...abc",
  "userPhone": "+919876543210",
  "sourceHub": "Pashan",
  "destinationHub": "Koregaon",
  "bicycleId": "bike_001",
  "bookingStatus": "booked",
  "allocatedMinutes": 45,
  "createdAt": 1708516800000
}
```

**Listener behavior:** `QRCodeScreen` subscribes to the booking record under the appropriate Realtime DB subpath (`bookings/hub_to_hub/{bookingId}` or `bookings/rental/{bookingId}`) and navigates to `RideStartedScreen` when `bookingStatus` becomes `"alloted"`.

---

## Navigation Flow

### Stack Management

**Search → Booking Map → Payment → QR Code**

| Step | Navigation Method | Stack Result |
|------|-------------------|--------------|
| Home to Search | Push | [Home, Search] |
| Search to Map | **pushReplacement** | [Home, BookingMap] |
| Map to Payment | Push | [Home, BookingMap, Payment] |
| Payment to QR | **pushAndRemoveUntil** | [Home, QRCode] |
| QR back | Pop | [Home] |

**Key Design:**
- After Search, original home is preserved
- After Payment, intermediate pages (Search, Payment) are cleared
- Back from QR returns directly to Home

---

## Configuration & Setup

### Prerequisites
1. **Flutter SDK:** 3.x+
2. **Android SDK:** Target API 31+
3. **Google Play Services:** Installed on device/emulator
4. **Internet Connection:** Required for Firebase & ORS API

### Firebase Setup
```bash
# Initialize Firebase
flutterfire configure

# Select:
# - iOS: Not required (android focus)
# - Android: Yes
# - Plugins: Firebase Core, Auth, Firestore, Database
```

### Environment Variables (Recommended)
Create `.env` file (not in repo):
```
ORS_API_KEY=your_ors_key_here
FIREBASE_PROJECT_ID=com.example.lastmile_transport
```

### Run Commands
```bash
# Clean & get dependencies
flutter clean
flutter pub get

# Run on connected device
flutter run

# Release build
flutter build apk --release
```

### Google Maps API Key
- Already configured in `AndroidManifest.xml` (under `android/app/src/main`)
- Device must have Google Play Services enabled

---

## Future Enhancements

### Phase 2: Ride Experience
- [x] Ride start detection
- [ ] Real-time ride tracking (live GPS)
- [ ] Automatic bill calculation based on actual distance
- [ ] Ride end & payment adjustment
- [ ] Ride history & receipt generation

### Phase 3: User Management
- [ ] User profile & preferences
- [ ] Saved favorite hubs
- [ ] Referral code & rewards
- [ ] Multiple payment methods saved
- [ ] Ride history & statistics

### Phase 4: Advanced Features
- [ ] Loyalty/Points system
- [ ] Dynamic pricing (peak hours)
- [ ] Subscription plans (daily/monthly passes)
- [ ] In-app support chat
- [ ] Bike maintenance alerts

### Phase 5: Admin Features
- [ ] Hub management dashboard
- [ ] Real-time bike inventory tracking
- [ ] Pricing management UI
- [ ] User analytics & reports
- [ ] Booking history viewer

---

## Common Issues & Solutions

### Issue 1: ORS API Distance Not Calculating
**Symptom:** Loading spinner stuck or "Unexpected ORS response structure" error

**Cause:** 
- API key expired or has no quota
- Hub coordinates missing/invalid (null lat/lon)
- ORS API response format changed

**Solution:**
1. Verify ORS API key in `search_page.dart` (line ~36)
2. Check Firestore hub docs have `Up` or `Down` with `lat` and `long`
3. Add debug print to see ORS response: `print('ORS Response: ${response.body}');`
4. Test ORS API directly: `curl -H "Authorization: {key}" https://api.openrouteservice.org/v2/directions/...`

---

### Issue 2: Bicycle Not Found at Hub
**Symptom:** "No bicycles available at source hub" snackbar

**Cause:**
- Realtime DB path structure incorrect
- No bikes with `availability: "yes"` at hub

**Solution:**
1. Check Realtime DB path: `bicycles/{sourceLocality}/{sourceHub}/{bikeId}`
2. Verify at least one bike has `availability: "yes"`
3. Add sample data if testing:
```
bicycles/Pune/Pashan/bike_001 = { availability: "yes" }
```

---

### Issue 3: Booking Not Saved in Database
**Symptom:** QR screen shows but booking not in Realtime DB

**Cause:**
- Firebase rules deny write access
- Database reference path wrong
- Network timeout during write

**Solution:**
1. Check Firebase Realtime DB rules allow `bookings` write
2. Verify reference path: bookings are created under `bookings/hub_to_hub` or `bookings/rental` (e.g. `DatabaseReference("bookings/hub_to_hub").push()`)
3. Add error handler: `catch (e) { print('Booking error: $e'); }`

---

### Issue 4: Back Navigation Goes to Wrong Page
**Symptom:** From Payment, back goes to Search instead of Map

**Cause:**
- `Navigator.push()` used instead of `pushReplacement()` at search
- `Navigator.pop()` instead of `pushAndRemoveUntil()` at payment

**Solution:**
- Search → Booking Map must use `pushReplacement()`
- Payment → QR must use `pushAndRemoveUntil((route) => route.isFirst)`

---

### Issue 5: Location Permission Denied
**Symptom:** App crashes on home load with "Location permissions permanently denied"

**Cause:**
- User denied location permission
- Permission not requested before use

**Solution:**
1. Check `AndroidManifest.xml` has:
```xml
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
```
2. Request runtime permissions in settings
3. Uninstall & reinstall app to reset permissions

---

## Deployment Checklist

- [ ] ORS API key moved to secure config/environment variables
- [ ] Firebase rules reviewed and secured
- [ ] All debug prints removed
- [ ] Error handling improved with user-friendly messages
- [ ] Offline fallback implemented
- [ ] Rate limiting on API calls
- [ ] Analytics integrated
- [ ] Crash reporting enabled
- [ ] Load testing completed
- [ ] Privacy policy & T&C reviewed

---

## Contacts & Troubleshooting

| Issue | Contact |
|-------|---------|
| Firebase Config | Firebase Console |
| ORS API Quota | OpenRouteService Dashboard |
| Build Errors | Flutter Doctor + verify SDK versions |
| GPS/Location | Device settings + Google Play Services |

---

**Document Version:** 1.0  
**Last Updated:** February 21, 2026  
**Status:** Active Development
